<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Okul Risk Haritası Anketi</title>
  <style>
    /* Genel Stil ve Renk Paleti */
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        padding: 20px 10px; /* Mobil padding */
        background: #f0f8ff; /* Açık mavi-beyaz arka plan */
        color: #333;
    }
    h1 { 
        text-align: center; 
        color: #007bff; /* Başlık için canlı mavi */
        font-size: 1.8em; 
        margin-bottom: 5px;
    }
    .form-container { 
        width: 100%;
        max-width: 760px; 
        margin: 20px auto; 
        background: white; 
        padding: 30px 20px;
        border-radius: 12px; 
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1); 
    }
    .form-container p {
        text-align: center;
        color: #555;
        margin-bottom: 30px;
        font-size: 1em;
    }
    /* Sınıf Seçimi Alanı */
    .sinif-select-group {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid #cceeff; /* Açık mavi kenarlık */
        border-radius: 8px;
        background: #f7fcff; /* Çok açık mavi arka plan */
    }

    /* Giriş Alanı Stilleri */
    select, input[type="number"] { 
        width: 100%; 
        max-width: 300px; /* Giriş genişliği sınırlı tutuldu */
        height: 44px;
        padding: 10px 15px; 
        border: 1px solid #ddd; 
        border-radius: 8px; 
        box-sizing: border-box;
        transition: border-color 0.3s, box-shadow 0.3s;
        margin-top: 5px; /* Cevap girişinin sorunun altında olduğunu vurgulamak için */
    }
    select:focus, input[type="number"]:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    /* Sınıf Kontrol Stilleri */
    #sinif.error { border: 2px solid #dc3545; }
    #sinif.success { border: 2px solid #28a745; }


    /* Sorular ve Cevap Kutuları (ALT ALTA DİZİLİM VE KUTULAMA) */
    .grid { 
        display: grid; 
        grid-template-columns: 1fr; /* Mobil ve küçük ekranlar için tek sütun */
        gap: 20px; 
        margin-top: 10px; 
    }
    .grid > div {
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        background: #ffffff; /* Soru kutusu rengi */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .grid label {
        margin: 0 0 5px 0; /* Soruyu input'tan ayır */
        font-weight: 700;
        font-size: 1.05em;
        color: #333;
    }

    /* Buton Grubu Stilleri */
    .button-group { 
        display: flex; 
        flex-direction: column; /* Mobil için dikey */
        gap: 15px; 
        margin-top: 40px; 
    }
    .button-group button { 
      padding: 15px 25px; 
      border: none; 
      border-radius: 8px; 
      font-size: 17px; 
      cursor: pointer; 
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .gonder-btn { background: #28a745; color: white; }
    .gonder-btn:hover:not([disabled]) { background: #218838; }
    .temizle-btn { background: #007bff; color: white; } /* Mavi Temizle butonu */
    .temizle-btn:hover { background: #0056b3; }
    
    /* Pasif buton görünümü */
    .gonder-btn[disabled] { background: #9e9e9e; cursor: not-allowed; }
    
    .info { 
        text-align: center; 
        color: #555; 
        margin-top: 25px; 
        font-weight: 500;
        padding: 10px;
        border-top: 1px solid #eee;
    }

    /* Masaüstü İyileştirmeleri (768px üzeri) */
    @media (min-width: 768px) {
        .form-container {
            padding: 40px 50px;
        }
        .button-group {
            flex-direction: row; /* Masaüstü için yatay */
            justify-content: center; 
        }
        /* Soruları iki sütuna bölme (Daha iyi okuma ve yerleşim için) */
        .grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }
    }
  </style>
</head>
<body>
  <div class="form-container">
    <div style="text-align:center; margin-bottom:20px;">
      <img src="logo.png" alt="Okul Logosu" style="max-height:80px;">
    </div>
    <h1>Okul Risk Haritası Anketi</h1>
    <p>Lütfen sınıfınızı seçin ve her maddeye ilgili öğrenci sayısını girin. Girişler en fazla 35 olabilir.</p>

    <div class="sinif-select-group">
        <label for="sinif">Sınıf / Şube</label>
        <select id="sinif" onchange="kontrolEt()"></select>
    </div>

    <div class="grid">
    </div>

    <div class="button-group">
        <button class="gonder-btn" id="gonderBtn" onclick="gonder()">Gönder</button>
        <button class="temizle-btn" onclick="temizle()">Temizle</button>
    </div>

    <div class="info" id="sonuc"></div>
  </div>

  <script>
    // **WEB_APP_URL, SADECE SİZİN URL'niz OLMALIDIR!**
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxDi_30Il4pBG7U8C5ViMu4Ji3Qn4hYw00RzSvuLvVzHERUElgPeySNH5AgEPFl_rRtnA/exec"; 

    let sinifDahaOnceDolduruldu = false;

    const siniflar = [
      "Seçiniz","1-A","1-B","1-C","1-D","1-E","1-F",
      "2-A","2-B","2-C","2-D","2-E","2-F",
      "2. Sınıf - Hafif Zihinsel / A Şubesi",
      "2. Sınıf - Orta-Ağır Zihinsel / AA Şubesi",
      "2. Sınıf - Otistik Hafif / A Şubesi",
      "3-A","3-B","3-C","3-D","3-E","3-F",
      "3. Sınıf - Hafif Zihinsel / A Şubesi",
      "3. Sınıf - Otistik Hafif / A Şubesi",
      "4-A","4-B","4-C","4-D","4-E","4-F",
      "4. Sınıf - Hafif Zihinsel / AA Şubesi",
      "4. Sınıf - Orta-Ağır Zihinsel / AA Şubesi",
      "4. Sınıf - Otistik Hafif / A Şubesi",
      "Diğer"
    ];

    const maddeler = [
      "Kaç öğrencinizin annesi en fazla ilkokul mezunu?", "Kaç öğrencinizin babası en fazla ilkokul mezunu?",
      "Sınıfınızda yalnızca tek çocuk olan kaç öğrenci var?", "Kaç öğrencinizin 5 veya daha fazla kardeşi var?",
      "Kaç öğrencinizin anne ve babası ayrı yaşıyor?", "Kaç öğrencinizin anne ve babası boşanmış?",
      "Sınıfınızda yalnızca annesi ile yaşayan kaç öğrenci var?", "Sınıfınızda yalnızca babası ile yaşayan kaç öğrenci var?",
      "Kaç öğrencinizin annesi hayatta değil?", "Kaç öğrencinizin babası hayatta değil?",
      "Kaç öğrencinizin anne ve babası hayatta değil?", "Sınıfınızda şehit çocuğu olan kaç öğrenci var?",
      "Kaç öğrenciniz yalnızca büyükanne/büyükbabasıyla yaşıyor?", "Kaç öğrenciniz yalnızca diğer akrabalarıyla yaşıyor?",
      "Kaç öğrenciniz koruyucu aile gözetiminde?", "Kaç öğrenciniz sevgi evlerinde kalıyor?",
      "Kaç öğrenciniz Sosyal Hizmetler Çocuk Esirgeme Kurumu'nda kalıyor?", "Kaç öğrencinizin ailesinde süreğen hastalık var?",
      "Kaç öğrencinizin ailesinde ruhsal hastalık var?", "Kaç öğrencinizin ailesinde bağımlı bireyler (alkol/madde) bulunuyor?",
      "Kaç öğrencinizin ailesinde cezai hüküm bulunuyor?", "Kaç öğrencinizin ailesi mevsimlik işçi?",
      "Kaç öğrenciniz aile içi şiddete maruz kalıyor?", "Sınıfınızda özel yetenekli tanısı konulan kaç öğrenci var?",
      "Kaç öğrencinizin yetersizlik alanında özel eğitim raporu var?", "Kaç öğrencinizin süreğen hastalığı var?",
      "Kaç öğrencinizin ruhsal hastalığı var?", "Kaç öğrencinizin ailesinde Danışmanlık Tedbir Kararı var?",
      "Kaç öğrencinizin ailesinde Eğitim Tedbir Kararı var?", "Kaç öğrenciniz maddi sıkıntı yaşıyor?",
      "Sınıfınızda sürekli devamsız olan kaç öğrenci var?", "Kaç öğrenciniz bir işte çalışıyor?",
      "Kaç öğrencinizin akademik başarısı düşük?", "Kaç öğrenciniz riskli akran grubuna dahil?",
      "Kaç öğrenciniz yabancı uyruklu?", "Sınıfınızda diğer belirttiğiniz durumda kaç öğrenci var?"
    ];

    // Sınıf seçimi doldurma
    const select = document.getElementById("sinif");
    siniflar.forEach(s => {
      let opt = document.createElement("option");
      opt.value = s; opt.text = s; select.add(opt);
    });

    // Maddeleri ekleme
    const grid = document.querySelector(".grid");
    maddeler.forEach((madde, i) => {
      let div = document.createElement("div");
      // Her maddeyi etiket (label) ve input olarak ayrı bir kutuya ekle
      div.innerHTML = `
            <label for="m${i+1}">${i+1}. ${madde}</label>
            <input type="number" min="0" max="35" id="m${i+1}" placeholder="Sayı (Max 35)">
        `;
      grid.appendChild(div);
    });


    // Sınıfı sunucudan kontrol eden fonksiyon
    function kontrolEt() {
        const sinif = document.getElementById("sinif").value;
        const sonucDiv = document.getElementById("sonuc");
        const gonderBtn = document.getElementById("gonderBtn");
        const sinifSelect = document.getElementById("sinif");

        if (!sinif || sinif === "Seçiniz") {
            sinifDahaOnceDolduruldu = false;
            gonderBtn.disabled = false;
            sinifSelect.className = '';
            sonucDiv.innerHTML = '';
            return;
        }

        sonucDiv.innerHTML = "<b style='color:#007bff'>Kontrol ediliyor...</b>";
        gonderBtn.disabled = true;
        sinifSelect.className = '';

        fetch(`${WEB_APP_URL}?sinif=${encodeURIComponent(sinif)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP Hata: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                sinifDahaOnceDolduruldu = data.exists;

                if (sinifDahaOnceDolduruldu) {
                    sonucDiv.innerHTML = `<b style='color:#dc3545'>⚠️ Uyarı: ${sinif} şubesi daha önce doldurulmuştur. Tekrar gönderim YAPILAMAZ.</b>`;
                    gonderBtn.disabled = true;
                    sinifSelect.className = 'error';
                } else {
                    sonucDiv.innerHTML = `<b style='color:#28a745'>✅ ${sinif} şubesi daha önce doldurulmamış. Gönderim yapılabilir.</b>`;
                    gonderBtn.disabled = false;
                    sinifSelect.className = 'success';
                }
            })
            .catch(error => {
                sonucDiv.innerHTML = "<b style='color:#dc3545'>HATA: Kontrol sırasında bir sorun oluştu. Lütfen tekrar deneyin.</b>";
                gonderBtn.disabled = true;
                sinifSelect.className = 'error';
                console.error("Kontrol hatası:", error);
            });
    }

    // GONDER FONKSİYONU
    function gonder() {
        // 1. Gerekli Kontroller
        if (!document.getElementById("sinif").value || document.getElementById("sinif").value === "Seçiniz") {
            alert("Lütfen Sınıf alanını doldurun.");
            return;
        }

        // 2. Kısıtlama Kontrolü (Daha Önce Dolduruldu mu?)
        if (sinifDahaOnceDolduruldu) {
            alert("Bu sınıf daha önce doldurulduğu için gönderim yapılamaz.");
            return;
        }

        // !!! GÜVENİLİR KISITLAMA KONTROLÜ (Boşluk ve 0-35 Aralığı) !!!
        const hatalıGirisBulundu = maddeler.some((_, i) => {
            let inputElement = document.getElementById(`m${i + 1}`);
            let deger = inputElement.value.trim();
            let sayiDeger;

            // KONTROL A: Boş Bırakıldı mı? (Yeni Kontrol)
            if (deger === "") {
                alert(`HATA: ${i + 1}. madde boş bırakılamaz. Lütfen 0 ile 35 arasında bir sayı girin.`);
                inputElement.focus();
                return true; // Hata bulundu, döngüyü durdur
            } 
            
            // KONTROL B: Sayı ve Sınırlar İçinde mi?
            sayiDeger = parseInt(deger);

            // Sayı değilse VEYA 0'dan küçük VEYA 35'ten büyükse
            if (isNaN(sayiDeger) || sayiDeger < 0 || sayiDeger > 35) {
                alert(`HATA: ${i + 1}. maddeye girilen değer ("${deger}") geçersizdir. Lütfen 0 ile 35 arasında bir sayı girin.`);
                inputElement.focus();
                return true; // Hata bulundu, döngüyü durdur
            }
            
            return false;
        });

        if (hatalıGirisBulundu) {
            return; // Hata varsa, gönderimi engelle
        }
        // !!! Kısıtlama Kontrolü Bitti !!!

        
        // Hata yoksa veri toplama başlar
        let data = {
            sinif: document.getElementById("sinif").value,
            tarih: new Date().toLocaleString()
        };

        // 3. Veri Toplama (Değerler zaten kontrol edildi)
        maddeler.forEach((_, i) => {
            let deger = document.getElementById(`m${i + 1}`).value.trim();
            data[`m${i + 1}`] = deger; 
        });

        // 4. Veriyi Gönderme
        document.getElementById("sonuc").innerHTML = "<b style='color:#007bff'>Lütfen bekleyin, verileriniz gönderiliyor...</b>";

        fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(data)
        }).then(() => {
            document.getElementById("sonuc").innerHTML = "<b style='color:#28a745'>✓ Teşekkürler! Cevaplarınız kaydedildi.</b>";
            sinifDahaOnceDolduruldu = true;
            document.getElementById("gonderBtn").disabled = true;
        }).catch(error => {
            document.getElementById("sonuc").innerHTML = "<b style='color:#dc3545'>HATA: Veri gönderilirken bir sorun oluştu.</b>";
            console.error('Gönderme hatası:', error);
        });
    }

    // TEMİZLE FONKSİYONU
    function temizle() {
        // Sınıf seçimini ilk değere ayarla
        document.getElementById("sinif").selectedIndex = 0;
        document.getElementById("sinif").className = '';

        // Tüm madde (input) alanlarını temizle
        maddeler.forEach((_, i) => {
            document.getElementById(`m${i+1}`).value = "";
        });

        // Sonuç durumunu sıfırla ve butonu etkinleştir
        sinifDahaOnceDolduruldu = false;
        document.getElementById("gonderBtn").disabled = false;
        document.getElementById("sonuc").innerHTML = "";

        alert("Form temizlendi.");
    }
  </script>
</body>
</html>
